# FE01. æŸ¥çœ‹æ–‡ç« 

ç”±æœ±åŒæ³‰åˆ›å»º, æœ€åä¿®æ”¹äºå››æœˆ 09, 2021

## æ–‡æ¡£å˜æ›´å†å²

| ç‰ˆæœ¬ |   æ—¥æœŸ    | è´Ÿè´£äºº |       è¯´æ˜       |
| :--: | :-------: | :----: | :--------------: |
|  v1  | 2021.3.27 | æœ±åŒæ³‰ |       åˆ›å»º       |
|  v2  | 2021.4.09 | æœ±åŒæ³‰ | è§£å†³å¤šæ¬¡æ¸²æŸ“é—®é¢˜ |

## 0xFF å¦‚ä½•å¯åŠ¨

1. [github](https://github.com/coderZsq) ä¸‹è½½ [coderZsq.product.doc](https://codeload.github.com/coderZsq/coderZsq.product.doc/zip/refs/heads/master) ä»“åº“;
2. è§£å‹ /02-æŠ€æœ¯æ–‡æ¡£/01-æºä»£ç /FE01-src.zip;
3. $ cd è¿›å…¥ recoder æ–‡ä»¶å¤¹;
4. $ npm i å®‰è£…ä¾èµ–åº“ (æ­¤æ­¥éª¤éœ€è¦ node ç¯å¢ƒ);
5. $ npm run serve å°†é¡¹ç›®è¿è¡Œèµ·æ¥;
6. ä¼šè‡ªåŠ¨åœ¨æµè§ˆå™¨è®¿é—® localhost:3000 ç«¯å£æ˜¾ç¤º;

## 0x00 ç¯å¢ƒæ­å»º

- ä½¿ç”¨ React å…¨å®¶æ¡¶è¿›è¡Œé¡¹ç›®çš„æ­å»º;
- ä½¿ç”¨ Ant Design ä½œä¸º UI çš„è®¾è®¡è¯­è¨€;
- ä½¿ç”¨ JavaScript ä½œä¸ºä¸»è¦çš„å¼€å‘è¯­è¨€.

## 0x01 æ¶æ„æ­å»º

1. å…ˆåŸºäº React è„šæ‰‹æ¶æ­å»ºåŸºç¡€æ¶æ„;
2. å…·ä½“é›†æˆåŠé¡¹ç›¸å…³æ¶æ„æ­å»ºå¯ä»¥é˜…è¯»[æºç ](https://github.com/coderZsq/coderZsq.practice.web/tree/master/recorder).

```
.
â”œâ”€â”€ craco.config.js
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ public
â”‚Â Â  â”œâ”€â”€ favicon.ico
â”‚Â Â  â””â”€â”€ index.html
â””â”€â”€ src
    â”œâ”€â”€ App.js
    â”œâ”€â”€ App.style.js
    â”œâ”€â”€ assets
    â”‚Â Â  â”œâ”€â”€ css
    â”‚Â Â  â”‚Â Â  â””â”€â”€ reset.css
    â”‚Â Â  â”œâ”€â”€ font
    â”‚Â Â  â””â”€â”€ img
    â”œâ”€â”€ common
    â”‚Â Â  â”œâ”€â”€ constants.js
    â”‚Â Â  â””â”€â”€ util
    â”‚Â Â      â”œâ”€â”€ formats.js
    â”‚Â Â      â”œâ”€â”€ hooks.js
    â”‚Â Â      â””â”€â”€ loadings.js
    â”œâ”€â”€ components
    â”‚Â Â  â”œâ”€â”€ app-header
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ index.js
    â”‚Â Â  â”‚Â Â  â””â”€â”€ style.js
    â”‚Â Â  â””â”€â”€ article
    â”‚Â Â      â”œâ”€â”€ index.js
    â”‚Â Â      â””â”€â”€ style.js
    â”œâ”€â”€ index.js
    â”œâ”€â”€ pages
    â”‚Â Â  â”œâ”€â”€ article
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ index.js
    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ store
    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ actionCreators.js
    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ constants.js
    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ index.js
    â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ reducer.js
    â”‚Â Â  â”‚Â Â  â””â”€â”€ style.js
    â”‚Â Â  â””â”€â”€ home
    â”‚Â Â      â””â”€â”€ index.js
    â”œâ”€â”€ router
    â”‚Â Â  â””â”€â”€ index.js
    â”œâ”€â”€ service
    â”‚Â Â  â”œâ”€â”€ article.js
    â”‚Â Â  â”œâ”€â”€ config.js
    â”‚Â Â  â””â”€â”€ request.js
    â””â”€â”€ store
        â”œâ”€â”€ index.js
        â””â”€â”€ reducer.js
```

## 0x02 å“åº”å¼å¸ƒå±€

- ä½¿ç”¨åª’ä½“æŸ¥è¯¢æ¥è¿›è¡Œå“åº”å¼å¸ƒå±€.

```less
margin: 0 auto;
width: 100%;
padding: 0 15px;
@media (min-width: 576px) {
  width: 90%;
}
@media (min-width: 768px) {
  width: 80%;
}
@media (min-width: 992px) {
  width: 70%;
}
@media (min-width: 1200px) {
  width: 60%;
}
@media (min-width: 1600px) {
  width: 50%;
}
```

## 0x03 æ ·å¼æ­å»º

CSS å°æŠ€å·§:

- flex äº¤å‰è½´å¯¹é½æ—¶ï¼Œå¯ä½¿ç”¨ margin è¿›è¡Œå¾®è°ƒï¼›
- åœ¨ flex çš„æƒ…å†µä¸‹ text-align ä¸èµ·æ•ˆæœï¼›

```less
display: flex;
justify-content: space-between;
align-items: center;

height: 65px;

.left {
  display: flex;
  align-items: center;

  .brand {
    text-align: center;

    font-size: 30px;
    width: 120px;
  }

  .greeting {
    text-align: center;

    border-left: 1px solid #333;
    margin-top: 4px;
    font-size: 14px;
    width: 120px;
  }
}

.right {
  text-align: center;

  width: 32px;
  height: 32px;
  line-height: 32px;
  margin-right: 15px;
  border-radius: 100%;
  border: 1px solid #333;
}
```

- é¼ æ ‡é€‰ä¸­æ—¶çš„æ ·å¼.

```less
::selection {
  color: #333;
  background-color: #ddd;
}
```

## 0x04 æ–‡ç« æ¥å£è®¿é—®

- å¯¹åº”å•æ¡å’Œå¤šæ¡è®°å½•çš„æ¥å£è®¿é—®.

```js
import request from './request';

export function getArticles(options) {
  const { type, page, size } = options;
  return request({
    url: '/articles',
    params: {
      type,
      page,
      size,
    },
  });
}

export function getArticle(id) {
  return request({
    url: '/articles',
    params: {
      id,
    },
  });
}
```

## 0x05 æ»šåŠ¨åŠ è½½

1. Ant-Design çš„ [List](https://ant.design/components/list-cn/) ç»„ä»¶å¹¶ä¸åŸç”Ÿæ”¯æŒæ»šåŠ¨åŠ è½½;
2. å®˜æ–¹æ¨èä½¿ç”¨ react-infinite-scroller å’Œ react-virtualized å‡ä¸æ”¯æŒ 17 ä»¥ä¸Šç‰ˆæœ¬çš„ React;

```
npm ERR! code ERESOLVE
npm ERR! ERESOLVE unable to resolve dependency tree
npm ERR!
npm ERR! While resolving: recorder@0.1.0
npm ERR! Found: react@17.0.2
npm ERR! node_modules/react
npm ERR!   react@"^17.0.2" from the root project
npm ERR!
npm ERR! Could not resolve dependency:
npm ERR! peer react@"^15.3.0 || ^16.0.0-alpha" from react-virtualized@9.22.3
npm ERR! node_modules/react-virtualized
npm ERR!   react-virtualized@"*" from the root project
```

3. å¯ä»¥é€šè¿‡ä¼ ç»Ÿæ–¹å¼ç›‘å¬ scroll äº‹ä»¶å¹¶ç»“åˆè‡ªå®šä¹‰ hook è¿›è¡Œå®ç°;

```js
useLoadMore(() => {
  setPage(page + 1);
});
```

4. å…¶ä¸­ const buffer = 800, è®¾ç½®çš„æ˜¯è·ç¦»åº•éƒ¨çš„ç¼“å†²å€¼.

```js
export function useLoadMore(callback) {
  const [loading, setLoading] = useState(true);

  const onScroll = useCallback(() => {
    const buffer = 800;
    if (
      loading &&
      window.scrollY + document.body.clientHeight >=
        document.body.scrollHeight - buffer
    ) {
      setLoading(false);
      callback();
      setTimeout(() => {
        setLoading(true);
      }, 0);
    }
  }, [loading, callback]);

  useEffect(() => {
    document.addEventListener('scroll', onScroll);
    return () => {
      document.removeEventListener('scroll', onScroll);
    };
  }, [onScroll]);
}
```

## 0x06 React ç¢°åˆ°çš„å‘

1. é¡µé¢é€šè¿‡è·¯ç”±è·³è½¬æ—¶, ç”±äºæ˜¯å•é¡µé¢åº”ç”¨, ä¼šå°†æ»šåŠ¨åç§»å€¼ä¼ é€’, æˆ‘ä»¬éœ€è¦è¿›è¡Œé‡ç½®;

2. ä¸ºä¿æŒä¸€è‡´æ€§, åŒæ ·ä½¿ç”¨è‡ªå®šä¹‰ hook è¿›è¡Œé‡ç½®;

```js
export function useBackTop() {
  useEffect(() => {
    document.documentElement.scrollTop = 0;
  }, []);
}
```

3. å½“é¡µé¢æ²¡æœ‰è¯·æ±‚åˆ°æ•°æ®çš„æ—¶å€™ React ä¼šæ¸²æŸ“ä¸­é—´çŠ¶æ€, ç›®å‰å¹¶æ²¡æœ‰å¾ˆå¥½çš„è§£å†³åŠæ³•;

![](img/1.png)

4. è¯¥ç»„ä»¶ä¼šè¿›è¡Œå¤šæ¬¡æ¸²æŸ“, ç›®å‰åŸå› ä¸æ˜, ç­‰å¾…åç»­è§‚å¯Ÿ.

![](img/2.png)

```jsx
export default memo(function SQHomePage() {
  console.log('SQHomePage è¿›è¡Œæ¸²æŸ“');

  const [page, setPage] = useState(1);

  const { articles } = useSelector(
    (state) => ({
      articles: state.getIn(['article', 'articles']),
    }),
    shallowEqual
  );

  const dispatch = useDispatch();

  useEffect(() => {
    dispatch(
      getArticlesAction({
        type: 'stock',
        page,
        size: HOME_ARTICLES_SIZE,
      })
    );
  }, [dispatch, page]);

  useLoadMore(() => {
    setPage(page + 1);
  });

  return (
    <List
      dataSource={articles}
      renderItem={(item) => (
        <List.Item>
          <SQArticle
            key={item.id}
            id={item.id}
            title={item.title}
            words={item.words}
            duration={item.duration}
            date={item.date}
            content={item.content}
          />
        </List.Item>
      )}
    />
  );
});
```

5. å½“å‰é¡µé¢ï¼ˆç»„ä»¶ï¼‰åŠ è½½äº†è¶³å¤Ÿå¤šçš„æ•°æ®ï¼Œ è¿›è¡Œè·¯ç”±è·³è½¬æ—¶å†è·³è½¬å›æ¥ä¼šè¿›è¡Œé‡æ–°æ¸²æŸ“ï¼Œ ä½†æ•°æ®éƒ½ç”¨ redux è¿›è¡Œå­˜å‚¨äº†ï¼Œ ä¸€ä¸‹å­å¤§è§„æ¨¡çš„æ•°æ®æ¸²æŸ“ä¼šé€ æˆé¡µé¢çš„å¡é¡¿, ç±»ä¼¼ Keep-Alive çš„æ–¹æ¡ˆå¬è¯´å¯ä»¥è§£å†³, ä½†å°è¯•åå‡å¤±æ•ˆ;

## 0x07 æ€§èƒ½ä¼˜åŒ–

1. æ¯æ¬¡è¯·æ±‚åªè¯·æ±‚æ­£å¥½å¯ä»¥è¿›è¡Œå±•ç¤ºçš„æ•°æ®;

```js
export const HOME_ARTICLES_SIZE = 2;
```

2. å¦‚æœè¯·æ±‚çš„æ•°æ®å’Œå½“å‰çš„æ•°æ®é¡µæ•°ç›¸åŒåˆ™é¿å…é‡å¤è¯·æ±‚;
3. è¯·æ±‚çš„é¡µæ•°æ§åˆ¶åœ¨æ€»é¡µæ•°å†…, é¿å…æ— æ•ˆçš„è¯·æ±‚;

```js
let curPage = -Infinity;
let totalPage = Infinity;
export const getArticlesAction = (options) => {
  return (dispatch) => {
    const { page, size } = options;
    if (curPage < page && page <= totalPage) {
      getArticles(options).then((res) => {
        curPage = page;
        totalPage = res.count / size;
        dispatch(changeArticlesAction(res));
      });
    }
  };
};
```

4. æ¯æ¬¡åœ¨åŸæ•°ç»„çš„åé¢æ ¹æ® size è¿›è¡Œç´¯åŠ ;

```js
function reducer(state = defaultState, action) {
  switch (action.type) {
    case actionTypes.CHANGE_ARTICLES:
      return state.set(
        'articles',
        state.get('articles').concat(action.articles)
      );
    case actionTypes.CHANGE_ARTICLE:
      return state.set('article', action.article);
    default:
      return state;
  }
}
```

5. ç”±äº markdown çš„å†…å®¹ä¼šéšç€æ•°æ®é‡å¤§å¹…å¢å¤§, ä¼šé€ æˆ 0x06 èŠ‚çš„ç¬¬ 5 æ¡å‘, è™½ç„¶ç›®å‰æ²¡æœ‰å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆ, ä½†ä½¿ç”¨ content.slice(0, 850), å¯¹æŠ˜å å­—ç¬¦ä¸²è¿›è¡Œæˆªå–, é™ä½æ¸²æŸ“æ•°æ®æ˜¯ç›®å‰çš„ä¸»è¦æ‰‹æ®µ.

```jsx
export default memo(function SQArticle(props) {
  const { id, title, duration, words, date, content } = props;
  const [collapse, setCollapse] = useState(true);

  return (
    <SQArticleWrapper>
      <NavLink to={'article/' + id}>
        <div className="title">{title}</div>
      </NavLink>
      <div className="info">
        <div className="item date">{formatDate(date, 'yyyy-MM-dd')}</div>
        <div className="item duration">è¯»å®Œéœ€è¦ {duration} åˆ†é’Ÿ</div>
        <div className="item words">å…± {words} å­—</div>
      </div>
      <div
        className={`content ${collapse ? 'collapse' : ''}`}
        dangerouslySetInnerHTML={{
          __html: marked(collapse ? content.slice(0, 850) : content),
        }}
      ></div>
      <div className="read-all" onClick={() => setCollapse(false)}>
        <span>{collapse ? 'é˜…è¯»å…¨æ–‡ ğŸ”½' : ''}</span>
      </div>
    </SQArticleWrapper>
  );
});
```

## 0x08 æˆå“å±•ç¤º

![](img/3.png)
![](img/4.png)

## 0x09 è§£å†³å¤šæ¬¡æ¸²æŸ“é—®é¢˜

- hooks.js
  è¿™æ˜¯å¯¹ React çš„æ¸²æŸ“æœºåˆ¶ä¸ç†Ÿç»ƒå¯¼è‡´çš„, è‡ªå®šä¹‰ hook ä¸­çš„æ¯ä¸€ä¸ª useState è¢«è§¦å‘éƒ½ä¼šè¿›è¡Œä¸€æ¬¡æ¸²æŸ“, è¿™ä¼šå¯¼è‡´åœ¨æ»šåŠ¨çš„æ—¶å€™è¿›è¡Œé¢‘ç¹çš„æ¸²æŸ“æ“ä½œ, æ•…å¯¼è‡´å¡é¡¿ç­‰ä¸€ç³»åˆ—çš„é—®é¢˜, å¦‚æœä¸æ˜¯çŠ¶æ€å­—æ®µæ˜¯ä¸éœ€è¦ä½¿ç”¨ useState æ¥å­˜å‚¨çš„, ä½¿ç”¨ useRef å³å¯è¾¾åˆ°æ•ˆæœ.

```js
export function useLoadMore(callback) {
  const loadingRef = useRef(true);
  const onScroll = useCallback(() => {
    const buffer = 300;
    if (
      loadingRef.current &&
      window.scrollY + document.body.clientHeight >=
        document.body.scrollHeight - buffer
    ) {
      loadingRef.current = false;
      callback();
      setTimeout(() => {
        loadingRef.current = true;
      }, 0);
    }
  }, [callback]);

  useEffect(() => {
    document.addEventListener('scroll', onScroll);
    return () => {
      document.removeEventListener('scroll', onScroll);
    };
  }, [onScroll]);
}
```

- home.js
  åˆ¤æ–­å‰ç½®, è¿›è¡Œæ¸²æŸ“çš„æ‹¦æˆª, ä¹‹å‰çš„ current ç®—æ³•æœ‰ç‚¹å° bug, ç°å·²ä¿®å¤, ä½†æ˜¯æ¯æ¬¡è¿˜æ˜¯ä¼šæ¸²æŸ“ä¸¤æ¬¡, åŸå› ä¸æ˜å¾…è§‚å¯Ÿ, åˆæ­¥çŒœæµ‹å¯èƒ½æ˜¯ useEffect å¯¼è‡´çš„.

```js
export default memo(function SQHomePage() {
  const [page, setPage] = useState(1);
  const renderedRef = useRef(false);

  const { articles } = useSelector(
    (state) => ({
      articles: state.getIn(['article', 'articles']),
    }),
    shallowEqual
  );

  let totalPage = useRef(-Infinity);
  const dispatch = useDispatch();

  useEffect(() => {
    renderedRef.current = true;
    dispatch(
      getArticlesAction(
        {
          page,
          size: HOME_ARTICLES_SIZE,
        },
        (count) => {
          totalPage.current = Math.floor((count - 1) / HOME_ARTICLES_SIZE) + 1;
        }
      )
    );
  }, [dispatch, page]);

  useLoadMore(() => {
    if (page < totalPage.current && renderedRef.current) {
      renderedRef.current = false;
      setPage(page + 1);
    }
  });
  ...
}
```

![](img/5.png)
